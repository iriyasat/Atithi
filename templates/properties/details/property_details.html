{% extends "base.html" %}

{% block title %}{{ property.title_en }} - Atithi{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Property Images -->
        <div class="col-md-8">
            <div id="propertyCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in property.images %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ image.image_url }}" class="d-block w-100" alt="{{ property.title_en }}" style="height: 400px; object-fit: cover;">
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>
        </div>

        <!-- Property Info and Booking -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h1 class="h3 mb-3">{{ property.title_en }}</h1>
                    <h2 class="h5 text-muted mb-3">{{ property.title_bn }}</h2>
                    <p class="text-muted mb-3">
                        <i class="fas fa-map-marker-alt"></i> {{ property.location_en }}
                    </p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h4 mb-0">à§³{{ property.price_per_night }}</h3>
                        <span class="text-muted">/ night</span>
                    </div>
                    <form id="bookingForm" class="mb-3">
                        <div class="mb-3">
                            <label for="check_in" class="form-label">{{ _('Check-in') }}</label>
                            <input type="date" class="form-control" id="check_in" name="check_in" required>
                        </div>
                        <div class="mb-3">
                            <label for="check_out" class="form-label">{{ _('Check-out') }}</label>
                            <input type="date" class="form-control" id="check_out" name="check_out" required>
                        </div>
                        <div class="mb-3">
                            <label for="guests" class="form-label">{{ _('Guests') }}</label>
                            <input type="number" class="form-control" id="guests" name="guests" min="1" value="1" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">{{ _('Book Now') }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Details Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="propertyTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="details-tab" data-bs-toggle="tab" href="#details" role="tab">
                        {{ _('Details') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="experiences-tab" data-bs-toggle="tab" href="#experiences" role="tab">
                        {{ _('Cultural Experiences') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="meals-tab" data-bs-toggle="tab" href="#meals" role="tab">
                        {{ _('Meal Options') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="transport-tab" data-bs-toggle="tab" href="#transport" role="tab">
                        {{ _('Transport') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="reviews-tab" data-bs-toggle="tab" href="#reviews" role="tab">
                        {{ _('Reviews') }}
                    </a>
                </li>
            </ul>

            <div class="tab-content mt-3" id="propertyTabsContent">
                <!-- Details Tab -->
                <div class="tab-pane fade show active" id="details" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <h3 class="h4 mb-3">{{ _('About this place') }}</h3>
                            <p>{{ property.description_en }}</p>
                            <p>{{ property.description_bn }}</p>
                            
                            <h4 class="h5 mt-4 mb-3">{{ _('Amenities') }}</h4>
                            <div class="row">
                                {% for amenity in property.amenities %}
                                <div class="col-md-6">
                                    <p><i class="fas fa-check text-success"></i> {{ amenity }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="h5 mb-3">{{ _('Property Type') }}</h4>
                                    <p class="mb-3">{{ property.property_type }}</p>
                                    
                                    <h4 class="h5 mb-3">{{ _('Region') }}</h4>
                                    <p class="mb-3">{{ property.region }}</p>
                                    
                                    <h4 class="h5 mb-3">{{ _('Safety Features') }}</h4>
                                    <ul class="list-unstyled">
                                        {% for feature in property.safety_features %}
                                        <li><i class="fas fa-shield-alt text-primary"></i> {{ feature }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cultural Experiences Tab -->
                <div class="tab-pane fade" id="experiences" role="tabpanel">
                    <div id="experiencesList" class="row">
                        <!-- Experiences will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Meal Options Tab -->
                <div class="tab-pane fade" id="meals" role="tabpanel">
                    <div id="mealsList" class="row">
                        <!-- Meals will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Transport Tab -->
                <div class="tab-pane fade" id="transport" role="tabpanel">
                    <div id="transportList" class="row">
                        <!-- Transport options will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            {% if current_user.is_authenticated %}
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4 class="h5 mb-3">{{ _('Write a Review') }}</h4>
                                    <form id="reviewForm">
                                        <div class="mb-3">
                                            <label class="form-label">{{ _('Rating') }}</label>
                                            <div class="rating">
                                                {% for i in range(5) %}
                                                <i class="fas fa-star" data-rating="{{ i + 1 }}"></i>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="comment_en" class="form-label">{{ _('Review (English)') }}</label>
                                            <textarea class="form-control" id="comment_en" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="comment_bn" class="form-label">{{ _('Review (Bangla)') }}</label>
                                            <textarea class="form-control" id="comment_bn" rows="3"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">{{ _('Submit Review') }}</button>
                                    </form>
                                </div>
                            </div>
                            {% endif %}

                            <div id="reviewsList">
                                <!-- Reviews will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const propertyId = {{ property.id }};
    let selectedRating = 0;

    // Load experiences
    function loadExperiences() {
        fetch(`/api/properties/${propertyId}/experiences`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const experiencesList = document.getElementById('experiencesList');
                    experiencesList.innerHTML = data.experiences.map(exp => `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${exp.title_en}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${exp.title_bn}</h6>
                                    <p class="card-text">${exp.description_en}</p>
                                    <p class="card-text">${exp.description_bn}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0">à§³${exp.price}</span>
                                        <span class="text-muted">${exp.duration} mins</span>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">${exp.max_participants} max participants</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Load meals
    function loadMeals() {
        fetch(`/api/properties/${propertyId}/meals`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const mealsList = document.getElementById('mealsList');
                    mealsList.innerHTML = data.meals.map(meal => `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${meal.name_en}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${meal.name_bn}</h6>
                                    <p class="card-text">${meal.description_en || ''}</p>
                                    <p class="card-text">${meal.description_bn || ''}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0">à§³${meal.price}</span>
                                        <span class="badge bg-primary">${meal.meal_type}</span>
                                    </div>
                                    <div class="mt-3">
                                        ${meal.dietary_info ? Object.entries(meal.dietary_info).map(([key, value]) => 
                                            value ? `<span class="badge bg-info me-1">${key}</span>` : ''
                                        ).join('') : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Load transport options
    function loadTransport() {
        fetch(`/api/properties/${propertyId}/transport`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const transportList = document.getElementById('transportList');
                    transportList.innerHTML = data.transport_options.map(opt => `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${opt.type.charAt(0).toUpperCase() + opt.type.slice(1)}</h5>
                                    <p class="card-text">${opt.description_en || ''}</p>
                                    <p class="card-text">${opt.description_bn || ''}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0">à§³${opt.price}</span>
                                        <span class="badge ${opt.is_available ? 'bg-success' : 'bg-danger'}">
                                            ${opt.is_available ? '{{ _("Available") }}' : '{{ _("Unavailable") }}'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Load reviews
    function loadReviews() {
        fetch(`/api/properties/${propertyId}/reviews`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const reviewsList = document.getElementById('reviewsList');
                    reviewsList.innerHTML = data.reviews.map(review => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">${review.user.name}</h5>
                                    <div class="text-warning">
                                        ${Array(review.rating).fill('<i class="fas fa-star"></i>').join('')}
                                    </div>
                                </div>
                                <p class="card-text">${review.comment_en || ''}</p>
                                <p class="card-text">${review.comment_bn || ''}</p>
                                <small class="text-muted">${new Date(review.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Handle tab changes
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('href').substring(1);
            switch(target) {
                case 'experiences':
                    loadExperiences();
                    break;
                case 'meals':
                    loadMeals();
                    break;
                case 'transport':
                    loadTransport();
                    break;
                case 'reviews':
                    loadReviews();
                    break;
            }
        });
    });

    // Handle review form submission
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        // Handle star rating
        document.querySelectorAll('.rating .fa-star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                document.querySelectorAll('.rating .fa-star').forEach(s => {
                    s.classList.toggle('text-warning', parseInt(s.dataset.rating) <= selectedRating);
                });
            });
        });

        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedRating) {
                alert('{{ _("Please select a rating") }}');
                return;
            }

            const formData = {
                rating: selectedRating,
                comment_en: document.getElementById('comment_en').value,
                comment_bn: document.getElementById('comment_bn').value
            };

            fetch(`/api/properties/${propertyId}/reviews`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    reviewForm.reset();
                    selectedRating = 0;
                    document.querySelectorAll('.rating .fa-star').forEach(star => {
                        star.classList.remove('text-warning');
                    });
                    loadReviews();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }

    // Handle booking form submission
    const bookingForm = document.getElementById('bookingForm');
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                check_in: document.getElementById('check_in').value,
                check_out: document.getElementById('check_out').value,
                guests: parseInt(document.getElementById('guests').value)
            };

            fetch(`/api/bookings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }

    // Initial load of reviews
    loadReviews();
});
</script>
{% endblock %} 